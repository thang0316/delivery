<h3 class="text-primary mb-3">üöÅ Qu·∫£n l√Ω Drone</h3>

<div class="card p-3 mb-4">
    <h5 class="text-success mb-3">‚ûï Th√™m Drone</h5>

    <div class="row g-2">
        <div class="col-md-3">
            <input id="model" class="form-control" placeholder="Model">
        </div>

        <div class="col-md-3">
            <input id="battery" type="number" class="form-control" placeholder="Pin (%)">
        </div>

        <div class="col-md-3">
            <select id="restaurantSelect" class="form-select">
                <option disabled selected>ƒêang t·∫£i nh√† h√†ng...</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="addDrone()">Th√™m</button>
        </div>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-primary">
    <tr>
        <th>ID</th>
        <th>Model</th>
        <th>Pin</th>
        <th>Tr·∫°ng th√°i</th>
        <th>Nh√† h√†ng</th>
        <th>X√≥a</th>
    </tr>
    </thead>
    <tbody id="droneTable">
    <tr><td colspan="6" class="text-center">ƒêang t·∫£i...</td></tr>
    </tbody>
</table>

<script>
    const API = window.apiBase || "http://localhost:8080/api";
    console.log("API Base:", API);
    
    let restaurantsCache = null; // Cache nh√† h√†ng

    // ========== LOAD RESTAURANTS ==========
    function loadRestaurants() {
        const sel = document.getElementById("restaurantSelect");

        console.log("üìç B·∫Øt ƒë·∫ßu load restaurants...");

        fetch(API + "/restaurants")
            .then(res => {
                console.log("Response status:", res.status);
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log("‚úì Restaurants loaded:", data);
                restaurantsCache = data;

                if(!data || data.length === 0) {
                    console.warn("‚ö†Ô∏è Kh√¥ng c√≥ nh√† h√†ng");
                    sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>`;
                    return;
                }

                sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>` + 
                    data.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
                
                console.log("‚úì Select updated - c√≥", sel.options.length, "nh√† h√†ng");
            })
            .catch(err => {
                console.error("‚úó L·ªói fetch restaurants:", err);
                sel.innerHTML = `<option value="">-- L·ªói t·∫£i nh√† h√†ng --</option>`;
            });
    }

    // ========== LOAD DRONES ==========
    async function loadDrones() {
        const tbody = document.getElementById("droneTable");

        try {
            const res = await fetch(API + "/drones");
            const data = await res.json();

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ drone n√†o</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.model}</td>
                    <td>${d.batteryLevel}%</td>
                    <td>${d.status}</td>
                    <td>${d.restaurant?.name || "‚Äî"}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteDrone('${d.id}')">X√≥a</button>
                    </td>
                </tr>
            `).join("");

        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">L·ªói t·∫£i drone</td></tr>`;
        }
    }

    // ========== CREATE ==========
    async function addDrone() {
        const data = {
            model: document.getElementById("model").value,
            batteryLevel: Number(document.getElementById("battery").value),
            restaurantId: document.getElementById("restaurantSelect").value
        };

        if (!data.model || !data.restaurantId) {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");
            return;
        }

        const res = await fetch(API + "/drones", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            alert("‚ùå L·ªói API!");
            return;
        }

        alert("üéâ Th√™m drone th√†nh c√¥ng!");
        restaurantsCache = null;  // X√≥a cache ƒë·ªÉ l·∫ßn sau fetch l·∫°i
        loadDrones();
    }

    // ========== DELETE ==========
    async function deleteDrone(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc?")) return;

        await fetch(API + "/drones/" + id, { method: "DELETE" });
        loadDrones();
    }

    // INIT
    function init() {
        console.log("üöÄ Init page...");
        // Pre-load restaurants ngay
        loadRestaurants();
        // Load drones
        loadDrones();
    }
    
    init();
</script>
