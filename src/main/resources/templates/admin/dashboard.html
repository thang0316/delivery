<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üçî FoodFast Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0d6efd;
            --bg-light: #f5f7fa;
            --card-bg: #ffffff;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --border: #e5e7eb;
            --sidebar-width: 240px;
            --radius: 16px;
        }

        body {
            font-family: "Segoe UI", sans-serif;
            background: var(--bg-light);
            overflow-x: hidden;
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 0; left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #fff;
            padding: 25px 0;
            border-right: 1px solid var(--border);
            box-shadow: 3px 0 12px rgba(0,0,0,0.08);
        }

        #sidebar h4 {
            text-align: center;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 28px;
        }

        #sidebar .nav-link {
            padding: 10px 18px;
            margin: 6px 12px;
            border-radius: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.25s;
        }

        #sidebar .nav-link:hover {
            transform: translateX(6px);
            background: rgba(13,110,253,0.08);
            color: var(--primary);
        }

        #sidebar .nav-link.active {
            background: var(--primary);
            color: #fff !important;
        }

        /* Main */
        #main {
            margin-left: var(--sidebar-width);
            padding: 35px;
        }

        section {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: 0.25s;
        }

        section.active-section {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>

<body>

<!-- SIDE BAR -->
<nav id="sidebar">
    <h4><i class="bi bi-lightning-charge-fill"></i> FoodFast Admin</h4>

    <ul class="nav flex-column">
        <li><a class="nav-link active" onclick="showSection('dashboard')"><i class="bi bi-speedometer2"></i> B·∫£ng ƒëi·ªÅu khi·ªÉn</a></li>
        <li><a class="nav-link" onclick="showSection('users','users.html')"><i class="bi bi-people"></i> Ng∆∞·ªùi d√πng</a></li>
        <li><a class="nav-link" onclick="showSection('restaurants','restaurants.html')"><i class="bi bi-shop"></i> Nh√† h√†ng</a></li>
        <li><a class="nav-link" onclick="showSection('orders','orders.html')"><i class="bi bi-box-seam"></i> ƒê∆°n h√†ng</a></li>
        <li><a class="nav-link" onclick="showSection('payments','payments.html')"><i class="bi bi-credit-card"></i> Thanh to√°n</a></li>
        <li><a class="nav-link" onclick="showSection('drones','drones.html')"><i class="bi bi-cpu"></i> Drone</a></li>
        <li><a class="nav-link" onclick="showSection('deliveries','deliveries.html')"><i class="bi bi-truck"></i> Giao h√†ng</a></li>
    </ul>
</nav>

<!-- MAIN -->
<main id="main">

    <!-- DASHBOARD -->
    <section id="dashboard" class="active-section">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-speedometer2 me-2"></i> T·ªïng quan h·ªá th·ªëng</h2>

            <button id="logoutBtn" class="btn btn-outline-danger btn-sm fw-semibold px-3">
                <i class="bi bi-box-arrow-right me-2"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card text-center p-4">
                    <i class="bi bi-people-fill text-primary fs-3"></i>
                    <h6>T·ªïng Ng∆∞·ªùi D√πng</h6>
                    <h2 id="userCount" class="text-primary">0</h2>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card text-center p-4">
                    <i class="bi bi-box-seam-fill text-danger fs-3"></i>
                    <h6>ƒê∆°n h√†ng</h6>
                    <h2 id="orderCount" class="text-danger">0</h2>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card text-center p-4">
                    <i class="bi bi-cpu-fill text-success fs-3"></i>
                    <h6>Drone</h6>
                    <h2 id="droneCount" class="text-success">0</h2>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card text-center p-4">
                    <i class="bi bi-cash-coin text-warning fs-3"></i>
                    <h6>Doanh thu</h6>
                    <h2 id="revenueTotal" class="text-warning">0 ‚Ç´</h2>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <h5 class="text-primary"><i class="bi bi-bar-chart-line"></i> Bi·ªÉu ƒë·ªì doanh thu</h5>
            <canvas id="revenueChart" height="80"></canvas>
        </div>

    </section>

    <!-- dynamic content -->
    <section id="users"></section>
    <section id="restaurants"></section>
    <section id="orders"></section>
    <section id="payments"></section>
    <section id="drones"></section>
    <section id="deliveries"></section>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.apiBase = "http://localhost:8080/api";

    var currentFetchController = null;
    var revenueChartInstance = null;

    /* ----------------------------
       SWITCH SECTION + LOAD PAGE
    -----------------------------*/
    async function showSection(id, htmlFile = null) {
        document.querySelectorAll("main section").forEach(x => x.classList.remove("active-section"));
        document.getElementById(id).classList.add("active-section");

        document.querySelectorAll("#sidebar .nav-link").forEach(x => x.classList.remove("active"));
        let link = [...document.querySelectorAll("#sidebar .nav-link")]
            .find(a => a.getAttribute("onclick").includes(id));
        if (link) link.classList.add("active");

        if (id === "dashboard") {
            loadCounts();
            loadRevenueChart();
            return;
        }

        if (htmlFile) await loadHTML(id, htmlFile);
    }

    /* ----------------------------
       LOAD FILE HTML
    -----------------------------*/
    async function loadHTML(sectionId, filePath) {

        if (currentFetchController) currentFetchController.abort();
        currentFetchController = new AbortController();
        var signal = currentFetchController.signal;

        var container = document.getElementById(sectionId);
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <div class="spinner-border mb-3"></div>
                <p>ƒêang t·∫£i...</p>
            </div>`;

        try {
            var res = await fetch("/admin/" + filePath, { signal });
            if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file: " + filePath);

            var html = await res.text();
            html = html.replace(/<\/?(html|head|body)[^>]*>/g, "");
            container.innerHTML = html;

            clearBackdrops();

            container.querySelectorAll("script").forEach(scr => {
                var s = document.createElement("script");
                s.textContent = scr.textContent.replace(/\b(let|const)\b/g, "var");
                document.body.appendChild(s);
            });

        } catch (err) {
            if (err.name !== "AbortError") {
                container.innerHTML = `<div class="alert alert-danger m-3">‚ùå ${err.message}</div>`;
            }
        }
    }

    /* ----------------------------
       LOAD DASHBOARD DATA
    -----------------------------*/
    async function loadCounts() {
        try {
            var [users, orders, drones, payments] = await Promise.all([
                fetch(apiBase + "/users").then(r => r.json()),
                fetch(apiBase + "/orders").then(r => r.json()),
                fetch(apiBase + "/drones").then(r => r.json()),
                fetch(apiBase + "/payments").then(r => r.json())
            ]);

            userCount.textContent = users.length;
            orderCount.textContent = orders.length;
            droneCount.textContent = drones.length;

            var total = payments.reduce((s, p) => s + (p.amount || 0), 0);
            revenueTotal.textContent = total.toLocaleString("vi-VN") + " ‚Ç´";
        } catch (e) { console.error(e); }
    }

    async function loadRevenueChart() {
        var res = await fetch(apiBase + "/payments");
        var payments = await res.json();

        var monthly = {};
        payments.forEach(p => {
            var m = new Date(p.createdAt).getMonth() + 1;
            monthly[m] = (monthly[m] || 0) + (p.amount || 0);
        });

        if (revenueChartInstance) revenueChartInstance.destroy();

        revenueChartInstance = new Chart(document.getElementById("revenueChart"), {
            type: "bar",
            data: {
                labels: Object.keys(monthly).map(m => "Th√°ng " + m),
                datasets: [{
                    label: "Doanh thu",
                    data: Object.values(monthly),
                    backgroundColor: "rgba(13,110,253,0.5)",
                    borderColor: "#0d6efd"
                }]
            }
        });
    }

    /* ----------------------------
       FIX TRI·ªÜT ƒê·ªÇ L·ªñI MODAL ƒêEN
    -----------------------------*/
    function clearBackdrops() {
        document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
        document.body.classList.remove("modal-open");
        document.body.style.overflow = "auto";
        document.body.style.paddingRight = "0";
    }

    document.addEventListener("shown.bs.modal", clearBackdrops);
    document.addEventListener("hidden.bs.modal", clearBackdrops);

    setInterval(clearBackdrops, 500);

    /* ----------------------------
       LOGOUT
    -----------------------------*/
    logoutBtn.onclick = () => {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
            localStorage.clear();
            window.location.href = "/login";
        }
    };

    document.addEventListener("DOMContentLoaded", () => showSection("dashboard"));
</script>

</body>
</html>
