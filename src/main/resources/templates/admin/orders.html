<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Qu·∫£n l√Ω ƒê∆°n h√†ng | FoodFast Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body { background-color:#f9fafc; color:#212529; font-family:"Segoe UI",sans-serif; padding:2rem; }
        h2 { font-weight:700; color:#0d6efd; display:flex; align-items:center; gap:10px; }
        .subtitle { color:#6c757d; margin-top:-6px; margin-bottom:1.5rem; }
        .card { background-color:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        .form-control, .form-select { background-color:#f8f9fa; color:#212529; border:1px solid #ced4da; border-radius:8px; }
        .btn-gradient { background:linear-gradient(90deg,#0d6efd,#00b4d8); border:none; color:white; font-weight:600; transition:all .3s; }
        .btn-gradient:hover { opacity:.9; transform:translateY(-1px); }
        .table thead { background-color:#0d6efd; color:white; }
        .table tbody tr:hover { background-color:#eef4ff; cursor:pointer; }
        .badge-status { border-radius:20px; padding:0.4rem 0.7rem; font-weight:500; }
        .badge-pending { background-color:#ffc107; color:#212529; }
        .badge-completed { background-color:#28a745; color:white; }
        .badge-cancelled { background-color:#dc3545; color:white; }
    </style>
</head>

<body>
<div class="container">
    <h2><i class="bi bi-basket2"></i> Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
    <p class="subtitle">T·∫°o, qu·∫£n l√Ω v√† theo d√µi ƒë∆°n h√†ng trong h·ªá th·ªëng</p>

    <!-- üîπ Form t·∫°o ƒë∆°n h√†ng -->
    <div class="card p-4 mb-4">
        <h5 class="text-primary mb-3"><i class="bi bi-plus-circle"></i> T·∫°o ƒë∆°n h√†ng m·ªõi</h5>

        <div class="row g-2">
            <div class="col-md-3">
                <select id="userSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i ng∆∞·ªùi d√πng...</option>
                </select>
            </div>

            <div class="col-md-3">
                <select id="restaurantSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i nh√† h√†ng...</option>
                </select>
            </div>

            <div class="col-md-3"><input id="customerName" class="form-control" placeholder="T√™n kh√°ch h√†ng"></div>
            <div class="col-md-3"><input id="customerPhone" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i"></div>
        </div>

        <div class="row g-2 mt-2">
            <div class="col-md-3"><input id="customerAddress" class="form-control" placeholder="ƒê·ªãa ch·ªâ giao h√†ng"></div>

            <div class="col-md-4">
                <select id="menuSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i m√≥n ƒÉn...</option>
                </select>
            </div>

            <div class="col-md-2"><input id="quantity" type="number" min="1" value="1" class="form-control"></div>

            <div class="col-md-3"><button class="btn btn-gradient w-100" onclick="createOrder()">Th√™m ƒë∆°n</button></div>
        </div>
    </div>

    <!-- üîπ B·∫£ng ƒë∆°n h√†ng -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle" id="orderTable">
                <thead>
                <tr>
                    <th>ID</th><th>Kh√°ch h√†ng</th><th>Nh√† h√†ng</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="6" class="text-center text-muted fst-italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let menuItems = [];

    // üü¢ Load ng∆∞·ªùi d√πng
    async function loadUsers() {
        try {
            const res = await fetch(`${API_BASE}/users`);
            const users = await res.json();
            document.getElementById("userSelect").innerHTML =
                users.map(u => `<option value="${u.id}">${u.username} (${u.id})</option>`).join("");
        } catch {
            document.getElementById("userSelect").innerHTML = `<option disabled>L·ªói t·∫£i ng∆∞·ªùi d√πng</option>`;
        }
    }

    // üü¢ Load nh√† h√†ng
    async function loadRestaurants() {
        try {
            const res = await fetch(`${API_BASE}/restaurants`);
            const restaurants = await res.json();
            document.getElementById("restaurantSelect").innerHTML =
                restaurants.map(r => `<option value="${r.id}">${r.name} (${r.id})</option>`).join("");
        } catch {
            document.getElementById("restaurantSelect").innerHTML = `<option disabled>L·ªói t·∫£i nh√† h√†ng</option>`;
        }
    }

    // üü¢ Load m√≥n ƒÉn
    async function loadMenuItems() {
        try {
            const res = await fetch(`${API_BASE}/menu-items`);
            menuItems = await res.json();
            document.getElementById("menuSelect").innerHTML =
                menuItems.map(m => `<option value="${m.id}">${m.name} - ${Number(m.price).toLocaleString()}‚Ç´</option>`).join("");
        } catch {
            document.getElementById("menuSelect").innerHTML = `<option disabled>L·ªói t·∫£i m√≥n ƒÉn</option>`;
        }
    }

    // üü¢ Load ƒë∆°n h√†ng ‚Äî FIX FULL NULL SAFE
    async function loadOrders() {
        const tbody = document.querySelector("#orderTable tbody");
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;

        try {
            const res = await fetch(`${API_BASE}/orders`);
            const orders = await res.json();

            if (!orders.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted fst-italic">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(o => {
                const total = Number(o.totalAmount || 0).toLocaleString();

                return `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.customerName || o.customer?.username || "Kh√¥ng r√µ"}</td>
                    <td>${o.restaurant?.name || "‚Äî"}</td>
                    <td>${total}‚Ç´</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="changeOrderStatus('${o.id}', this.value)">
                            <option value="PENDING" ${o.status === 'PENDING' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="CONFIRMED" ${o.status === 'CONFIRMED' ? 'selected' : ''}>ƒê√£ x√°c nh·∫≠n</option>
                            <option value="DELIVERING" ${o.status === 'DELIVERING' ? 'selected' : ''}>ƒêang giao</option>
                            <option value="COMPLETED" ${o.status === 'COMPLETED' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            <option value="CANCELED" ${o.status === 'CANCELED' ? 'selected' : ''}>H·ªßy</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="deleteOrder('${o.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join("");
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">L·ªói t·∫£i ƒë∆°n h√†ng!</td></tr>`;
        }
    }

    // üü¢ T·∫°o ƒë∆°n h√†ng (chu·∫©n format C1)
    async function createOrder() {
        const userId = document.getElementById("userSelect").value;
        const restaurantId = document.getElementById("restaurantSelect").value;
        const customerName = document.getElementById("customerName").value.trim();
        const customerPhone = document.getElementById("customerPhone").value.trim();
        const customerAddress = document.getElementById("customerAddress").value.trim();
        const menuItemId = document.getElementById("menuSelect").value;
        const quantity = parseInt(document.getElementById("quantity").value);

        if (!userId || !restaurantId || !customerName || !customerPhone || !customerAddress || !menuItemId) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        const data = {
            userId,
            restaurantId,
            customerName,
            customerPhone,
            customerAddress,
            items: [{ menuItemId, quantity }]
        };

        try {
            const res = await fetch(`${API_BASE}/orders`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!res.ok) throw new Error(await res.text());

            alert("‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!");
            loadOrders();
        } catch (err) {
            alert("‚ùå L·ªói t·∫°o ƒë∆°n h√†ng!\n" + err.message);
        }
    }

    // üü¢ C·∫≠p nh·∫≠t tr·∫°ng th√°i
    async function changeOrderStatus(id, status) {
        try {
            const res = await fetch(`${API_BASE}/orders/${id}/status?status=${status}`, { method: "PUT" });
            if (!res.ok) throw new Error(await res.text());
            loadOrders();
        } catch (err) {
            alert("‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i!\n" + err.message);
            loadOrders();
        }
    }

    // üü¢ C·∫≠p nh·∫≠t tr·∫°ng th√°i (legacy)
    async function updateStatus(id, status) {
        await changeOrderStatus(id, status);
    }

    // üü¢ X√≥a ƒë∆°n h√†ng
    async function deleteOrder(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng n√†y?")) return;
        try {
            const res = await fetch(`${API_BASE}/orders/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error(await res.text());
            alert("üóëÔ∏è ƒê∆°n h√†ng ƒë√£ b·ªã x√≥a!");
            loadOrders();
        } catch {
            alert("‚ùå Kh√¥ng th·ªÉ x√≥a ƒë∆°n h√†ng!");
        }
    }

    // üü¢ Kh·ªüi ch·∫°y
    (async () => {
        await loadUsers();
        await loadRestaurants();
        await loadMenuItems();
        await loadOrders();
    })();
</script>

</body>
</html>
