<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>üöö Qu·∫£n l√Ω Giao h√†ng | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light p-4">
<div class="container">
    <h3 class="text-primary mb-3">üöö Qu·∫£n l√Ω Giao h√†ng</h3>

    <!-- üîπ B·∫£ng danh s√°ch giao h√†ng -->
    <table class="table table-striped align-middle">
        <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>ƒê∆°n h√†ng</th>
            <th>Drone</th>
            <th>Tr·∫°ng th√°i</th>
            <th>B·∫Øt ƒë·∫ßu</th>
            <th>K·∫øt th√∫c</th>
        </tr>
        </thead>
        <tbody id="deliveryTable">
        <tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
        </tbody>
    </table>

    <!-- üîπ Form th√™m giao h√†ng -->
    <div class="mt-4 p-3 border bg-white rounded">
        <h5 class="text-success mb-3">‚ûï Th√™m Giao h√†ng m·ªõi</h5>
        <div class="row g-2">
            <div class="col-md-3">
                <select id="orderSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i ƒë∆°n h√†ng...</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="droneSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i drone...</option>
                </select>
            </div>
            <div class="col-md-2">
                <input id="status" class="form-control" placeholder="Tr·∫°ng th√°i" />
            </div>
            <div class="col-md-2">
                <input id="startTime" type="datetime-local" class="form-control" />
            </div>
            <div class="col-md-2">
                <input id="endTime" type="datetime-local" class="form-control" />
            </div>
            <div class="col-12 mt-2 text-end">
                <button class="btn btn-primary px-4" onclick="createDelivery()">Th√™m</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    // üü¢ Load danh s√°ch ƒë∆°n h√†ng
    async function loadOrders() {
        const select = document.getElementById("orderSelect");
        try {
            const res = await fetch(`${API_BASE}/orders`);
            const data = await res.json();
            if (!data.length) {
                select.innerHTML = `<option disabled>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</option>`;
                return;
            }
            select.innerHTML = data.map(o =>
                `<option value="${o.id}">#${o.id} - ${o.status || "Ch∆∞a r√µ"}</option>`
            ).join("");
        } catch (err) {
            console.error("‚ùå L·ªói t·∫£i orders:", err);
            select.innerHTML = `<option disabled>L·ªói t·∫£i ƒë∆°n h√†ng</option>`;
        }
    }

    // üü¢ Load danh s√°ch drone
    async function loadDrones() {
        const select = document.getElementById("droneSelect");
        try {
            const res = await fetch(`${API_BASE}/drones`);
            const data = await res.json();
            if (!data.length) {
                select.innerHTML = `<option disabled>Kh√¥ng c√≥ drone n√†o</option>`;
                return;
            }
            select.innerHTML = data.map(d =>
                `<option value="${d.id}">${d.model} (${d.status})</option>`
            ).join("");
        } catch (err) {
            console.error("‚ùå L·ªói t·∫£i drones:", err);
            select.innerHTML = `<option disabled>L·ªói t·∫£i drone</option>`;
        }
    }

    // üü¢ Load danh s√°ch delivery
    async function loadDeliveries() {
        const tbody = document.getElementById("deliveryTable");
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/deliveries`);
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch giao h√†ng!");
            const deliveries = await res.json();

            if (!deliveries.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted fst-italic">Ch∆∞a c√≥ giao h√†ng n√†o</td></tr>`;
                return;
            }

            tbody.innerHTML = deliveries.map(d => `
      <tr>
        <td>${d.id}</td>
        <td>${d.order?.id || "‚Äî"}</td>
        <td>${d.drone?.model || "‚Äî"}</td>
        <td>${d.status}</td>
        <td>${d.startTime || "‚Äî"}</td>
        <td>${d.endTime || "‚Äî"}</td>
      </tr>
    `).join("");
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‚ùå ${err.message}</td></tr>`;
        }
    }

    // üü¢ Th√™m giao h√†ng m·ªõi
    async function createDelivery() {
        const orderId = document.getElementById("orderSelect").value;
        const droneId = document.getElementById("droneSelect").value;
        const status = document.getElementById("status").value.trim();
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        if (!orderId || !droneId || !status) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        const data = {
            orderId,
            droneId,
            status,
            startTime: startTime ? new Date(startTime) : null,
            endTime: endTime ? new Date(endTime) : null
        };

        try {
            const res = await fetch(`${API_BASE}/deliveries`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            alert("‚úÖ Th√™m giao h√†ng th√†nh c√¥ng!");
            loadDeliveries();
        } catch (err) {
            alert("‚ùå L·ªói th√™m giao h√†ng!\n" + err.message);
        }
    }

    // üü¢ Khi t·∫£i trang
    (async () => {
        await loadOrders();
        await loadDrones();
        await loadDeliveries();
    })();
</script>
</body>
</html>
