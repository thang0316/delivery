<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<div class="container p-3">

    <h3 class="text-primary mb-3">üöö Qu·∫£n l√Ω Giao h√†ng</h3>

    <!-- Form th√™m giao h√†ng -->
    <div class="p-3 border bg-white rounded mb-3">
        <h5 class="text-success mb-3">‚ûï Th√™m giao h√†ng</h5>
        <div class="row g-2">
            <div class="col-md-4">
                <select id="orderSelectDelivery" class="form-select">
                    <option disabled selected>ƒêang t·∫£i...</option>
                </select>
            </div>
            <div class="col-md-4">
                <select id="droneSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i...</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button onclick="createDelivery()" class="btn btn-primary w-100">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- Form c·∫≠p nh·∫≠t v·ªã tr√≠ gi·∫£ l·∫≠p -->
    <div class="p-3 border bg-white rounded mb-3">
        <h5 class="text-info mb-3">üìç C·∫≠p nh·∫≠t v·ªã tr√≠ gi·∫£ l·∫≠p Drone</h5>
        <div class="row g-2">
            <div class="col-md-3">
                <select id="deliverySelectLocation" class="form-select">
                    <option disabled selected>Ch·ªçn delivery...</option>
                </select>
            </div>
            <div class="col-md-2">
                <input id="simLatitude" type="number" class="form-control" placeholder="Vƒ© ƒë·ªô" step="0.000001" value="21.0285">
            </div>
            <div class="col-md-2">
                <input id="simLongitude" type="number" class="form-control" placeholder="Kinh ƒë·ªô" step="0.000001" value="105.8542">
            </div>
            <div class="col-md-2">
                <button onclick="updateSimulatedLocation()" class="btn btn-info w-100">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>

    <!-- B·∫£n ƒë·ªì -->
    <div id="deliveryMap" style="height: 400px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">B·∫£n ƒë·ªì s·∫Ω t·∫£i khi c√≥ delivery...</div>
    </div>

    <!-- Danh s√°ch giao h√†ng -->
    <table class="table table-striped align-middle">
        <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>ƒê∆°n h√†ng</th>
            <th>Drone</th>
            <th>Vƒ© ƒë·ªô</th>
            <th>Kinh ƒë·ªô</th>
            <th>Tr·∫°ng th√°i</th>
            <th>B·∫Øt ƒë·∫ßu</th>
            <th>K·∫øt th√∫c</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="deliveryTable">
        <tr><td colspan="9" class="text-center text-muted">ƒêang t·∫£i...</td></tr>
        </tbody>
    </table>

</div>

<script>

    var API_BASE = window.apiBase;
    var map = null;
    var markers = {};

    function initMap() {
        if(map) return; // Ch·ªâ init m·ªôt l·∫ßn
        
        map = L.map('deliveryMap', {
            center: [21.0285, 105.8542], // H√† N·ªôi
            zoom: 13
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Click map ƒë·ªÉ c·∫≠p nh·∫≠t v·ªã tr√≠
        map.on('click', function(e) {
            let selectedDelivery = document.getElementById("deliverySelectLocation").value;
            if(!selectedDelivery) {
                alert("Vui l√≤ng ch·ªçn delivery tr∆∞·ªõc!");
                return;
            }
            
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            document.getElementById("simLatitude").value = lat.toFixed(6);
            document.getElementById("simLongitude").value = lng.toFixed(6);
            
            // Auto c·∫≠p nh·∫≠t
            updateSimulatedLocation();
        });
    }

    function updateMapMarkers(deliveries) {
        if(!map) initMap();

        // X√≥a markers c≈©
        Object.keys(markers).forEach(key => {
            map.removeLayer(markers[key]);
        });
        markers = {};

        // Th√™m markers m·ªõi
        if(deliveries.length > 0) {
            deliveries.forEach(d => {
                if(d.currentLatitude && d.currentLongitude) {
                    var marker = L.marker([d.currentLatitude, d.currentLongitude], {
                        icon: L.icon({
                            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3597/3597911.png',
                            iconSize: [32, 32],
                            popupAnchor: [0, -15]
                        })
                    });

                    var statusColor = d.status === 'DELIVERING' ? '#0d6efd' : 
                                     d.status === 'COMPLETED' ? '#198754' : '#dc3545';
                    
                    marker.bindPopup(`
                        <div style="font-size: 12px;">
                            <strong>Delivery #${d.id}</strong><br>
                            Order: #${d.order?.id || '-'}<br>
                            Drone: ${d.drone?.model || '-'}<br>
                            <span style="color: ${statusColor}; font-weight: bold;">${d.status}</span><br>
                            Vƒ© ƒë·ªô: ${d.currentLatitude.toFixed(6)}<br>
                            Kinh ƒë·ªô: ${d.currentLongitude.toFixed(6)}
                        </div>
                    `);

                    marker.addTo(map);
                    markers['delivery_' + d.id] = marker;
                }
            });

            // Auto fit bounds
            if(Object.keys(markers).length > 0) {
                var group = new L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
    }

    function loadOrders() {
        var select = document.getElementById("orderSelectDelivery");

        fetch(API_BASE + "/orders")
            .then(r => r.json())
            .then(data => {
                // Ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n (CONFIRMED)
                const confirmedOrders = data.filter(o => o.status === 'CONFIRMED');
                
                if(confirmedOrders.length === 0) {
                    select.innerHTML = `<option disabled selected>Kh√¥ng c√≥ ƒë∆°n h√†ng c·∫ßn giao</option>`;
                } else {
                    select.innerHTML = confirmedOrders.map(o =>
                        `<option value="${o.id}" data-restaurant-id="${o.restaurant?.id || ''}">#${o.id} - ${o.customer?.fullName || "Unknown"}</option>`
                    ).join("");
                    
                    // Sau khi load orders, filter drone cho order ƒë·∫ßu ti√™n
                    setTimeout(() => {
                        select.selectedIndex = 1;
                        filterDronesByRestaurant();
                    }, 100);
                }
                
                // L·∫Øng nghe khi ch·ªçn order ƒë·ªÉ filter drone
                select.addEventListener('change', filterDronesByRestaurant);
            })
            .catch(err => {
                console.error("L·ªói load orders:", err);
                select.innerHTML = `<option disabled selected>L·ªói t·∫£i ƒë∆°n h√†ng</option>`;
            });
    }

    function filterDronesByRestaurant() {
        var orderSelect = document.getElementById("orderSelectDelivery");
        var selectedOption = orderSelect.options[orderSelect.selectedIndex];
        
        // B·ªè qua n·∫øu l√† disabled option
        if(selectedOption.disabled) {
            console.warn("‚ö†Ô∏è Selected option is disabled, skipping...");
            return;
        }
        
        var restaurantId = selectedOption.getAttribute('data-restaurant-id');
        
        console.log("Selected order:", selectedOption.value, "Restaurant ID:", restaurantId);
        
        if(!restaurantId || restaurantId.trim() === '') {
            alert("‚ö†Ô∏è ƒê∆°n h√†ng n√†y kh√¥ng c√≥ th√¥ng tin nh√† h√†ng! Vui l√≤ng ki·ªÉm tra d·ªØ li·ªáu order.");
            return;
        }
        
        var droneSelect = document.getElementById("droneSelect");
        
        // Filter drone c·ªßa nh√† h√†ng
        fetch(API_BASE + "/drones")
            .then(r => r.json())
            .then(data => {
                const restaurantDrones = data.filter(d => d.restaurant?.id == restaurantId && d.status === 'AVAILABLE');
                
                console.log("Filter drones cho nh√† h√†ng:", restaurantId, "‚Üí", restaurantDrones.length, "drone");
                
                if(restaurantDrones.length === 0) {
                    droneSelect.innerHTML = `<option disabled selected>Kh√¥ng c√≥ drone s·∫µn s√†ng c·ªßa nh√† h√†ng n√†y</option>`;
                } else {
                    droneSelect.innerHTML = restaurantDrones.map(d =>
                        `<option value="${d.id}">${d.model}</option>`
                    ).join("");
                }
            })
            .catch(err => {
                console.error("L·ªói fetch drones:", err);
                droneSelect.innerHTML = `<option disabled selected>L·ªói t·∫£i drone</option>`;
            });
    }

    function loadDrones() {
        // Kh√¥ng c·∫ßn pre-load n·ªØa v√¨ kh√¥ng d√πng cache
    }

    function loadDeliveries() {
        var tbody = document.getElementById("deliveryTable");
        var selectLocation = document.getElementById("deliverySelectLocation");

        fetch(API_BASE + "/deliveries")
            .then(r => r.json())
            .then(data => {
                updateMapMarkers(data);
                
                // Populate location selector
                selectLocation.innerHTML = `<option disabled selected>Ch·ªçn delivery...</option>` + 
                    data.map(d =>
                        `<option value="${d.id}">#${d.id} - ${d.drone?.model || "Drone"}</option>`
                    ).join("");

                tbody.innerHTML = data.map(d => `
                    <tr>
                        <td>${d.id}</td>
                        <td>#${d.order?.id || "-"}</td>
                        <td>${d.drone?.model || "-"}</td>
                        <td>${d.currentLatitude ? d.currentLatitude.toFixed(6) : "-"}</td>
                        <td>${d.currentLongitude ? d.currentLongitude.toFixed(6) : "-"}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="changeDeliveryStatus('${d.id}', this.value)">
                                <option value="DELIVERING" ${d.status === 'DELIVERING' ? 'selected' : ''}>DELIVERING</option>
                                <option value="COMPLETED" ${d.status === 'COMPLETED' ? 'selected' : ''}>COMPLETED</option>
                                <option value="CANCELED" ${d.status === 'CANCELED' ? 'selected' : ''}>CANCELED</option>
                            </select>
                        </td>
                        <td>${d.startTime || "-"}</td>
                        <td>${d.endTime || "-"}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteDelivery('${d.id}')">X√≥a</button>
                        </td>
                    </tr>
                `).join("");
            });
    }

    function createDelivery() {

        var data = {
            orderId: document.getElementById("orderSelectDelivery").value,
            droneId: document.getElementById("droneSelect").value,
            currentLatitude: 0,
            currentLongitude: 0
        };

        if(!data.orderId || !data.droneId) {
            alert("Vui l√≤ng ch·ªçn ƒë∆°n h√†ng v√† drone!");
            return;
        }

        fetch(API_BASE + "/deliveries", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(data)
        })
        .then(r => {
            if(r.ok) {
                loadDeliveries();
                alert("ƒê√£ th√™m giao h√†ng!");
                document.getElementById("orderSelectDelivery").value = "";
                document.getElementById("droneSelect").value = "";
            } else {
                alert("L·ªói: " + r.statusText);
            }
        });
    }

    function changeDeliveryStatus(deliveryId, newStatus) {
        fetch(API_BASE + "/deliveries/" + deliveryId + "/status?status=" + newStatus, {
            method: "PUT",
            headers: {"Content-Type": "application/json"}
        })
        .then(r => {
            if(r.ok) {
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                loadDeliveries();
            } else {
                alert("L·ªói: " + r.statusText);
                loadDeliveries();
            }
        })
        .catch(err => {
            alert("L·ªói: " + err.message);
            loadDeliveries();
        });
    }

    function deleteDelivery(deliveryId) {
        if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?")) return;

        fetch(API_BASE + "/deliveries/" + deliveryId, {
            method: "DELETE"
        })
        .then(() => {
            loadDeliveries();
            alert("ƒê√£ x√≥a!");
        });
    }

    function updateSimulatedLocation() {
        const deliveryId = document.getElementById("deliverySelectLocation").value;
        const latitude = parseFloat(document.getElementById("simLatitude").value);
        const longitude = parseFloat(document.getElementById("simLongitude").value);

        if(!deliveryId) {
            alert("Vui l√≤ng ch·ªçn delivery!");
            return;
        }

        if(isNaN(latitude) || isNaN(longitude)) {
            alert("Vui l√≤ng nh·∫≠p to·∫° ƒë·ªô h·ª£p l·ªá!");
            return;
        }

        fetch(API_BASE + "/deliveries/" + deliveryId + "/location?latitude=" + latitude + "&longitude=" + longitude, {
            method: "PUT",
            headers: {"Content-Type": "application/json"}
        })
        .then(r => {
            if(r.ok) {
                alert("C·∫≠p nh·∫≠t v·ªã tr√≠ th√†nh c√¥ng!");
                loadDeliveries();
            } else {
                alert("L·ªói: " + r.statusText);
            }
        })
        .catch(err => {
            alert("L·ªói: " + err.message);
        });
    }

    loadOrders();
    loadDeliveries();

</script>
