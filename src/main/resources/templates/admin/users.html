<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üë§ Qu·∫£n l√Ω Ng∆∞·ªùi d√πng | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body { background-color:#f9fafc; color:#212529; font-family:"Segoe UI",sans-serif; padding:2rem; }
        h2 { font-weight:700; color:#0d6efd; display:flex; align-items:center; gap:10px; }
        .subtitle { color:#6c757d; margin-top:-6px; margin-bottom:1.5rem; }

        .card { background-color:#fff; border:1px solid #e5e7eb; border-radius:14px;
            box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        .form-control, .form-select { background-color:#f8f9fa; color:#212529;
            border:1px solid #ced4da; border-radius:8px; }
        .btn-gradient { background:linear-gradient(90deg,#0d6efd,#00b4d8); border:none;
            color:white; font-weight:600; transition:all .3s; }
        .btn-gradient:hover { opacity:.9; transform:translateY(-1px); }

        .table thead { background-color:#0d6efd; color:white; }
        .table tbody tr:hover { background-color:#eef4ff; cursor:pointer; }

        .badge { padding:0.4rem 0.7rem; border-radius:20px; font-size:0.85rem; }
        .badge-active { background-color:#28a745; color:white; }
        .badge-disabled { background-color:#dc3545; color:white; }

        td.editing input {
            background-color:#e7f1ff !important;
            border-color:#0d6efd;
            width: 100%;
        }
    </style>
</head>

<body>
<div class="container">
    <h2><i class="bi bi-people-fill"></i> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
    <p class="subtitle">Th·ªëng k√™, th√™m, ch·ªânh s·ª≠a v√† x√≥a t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng</p>

    <!-- üîπ Th·ªëng k√™ ng∆∞·ªùi d√πng -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-primary fs-4"><i class="bi bi-people-fill"></i></div>
                <div class="fw-bold fs-5" id="totalUsers">0</div>
                <div class="text-muted">T·ªïng ng∆∞·ªùi d√πng</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-success fs-4"><i class="bi bi-shield-lock"></i></div>
                <div class="fw-bold fs-5" id="adminCount">0</div>
                <div class="text-muted">Admin</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-info fs-4"><i class="bi bi-shop"></i></div>
                <div class="fw-bold fs-5" id="restaurantCount">0</div>
                <div class="text-muted">Restaurant</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-warning fs-4"><i class="bi bi-person"></i></div>
                <div class="fw-bold fs-5" id="customerCount">0</div>
                <div class="text-muted">Customer</div>
            </div>
        </div>
    </div>

    <!-- üîπ Form th√™m ng∆∞·ªùi d√πng -->
    <div class="card p-4 mb-4">
        <h5 class="text-primary mb-3"><i class="bi bi-person-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi</h5>
        <div class="row g-2">
            <div class="col-md-2"><input id="username" class="form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p"></div>
            <div class="col-md-2"><input id="firstName" class="form-control" placeholder="H·ªç"></div>
            <div class="col-md-2"><input id="lastName" class="form-control" placeholder="T√™n"></div>
            <div class="col-md-3"><input id="email" type="email" class="form-control" placeholder="Email"></div>
            <div class="col-md-2"><input id="phone" class="form-control" placeholder="SƒêT"></div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col-md-3"><input id="password" type="password" class="form-control" placeholder="M·∫≠t kh·∫©u"></div>

            <!-- ‚≠ê FIX CH√çNH ·ªû ƒê√ÇY -->
            <div class="col-md-3">
                <select id="roleSelect" class="form-select">
                    <option value="1">ADMIN</option>
                    <option value="2">CUSTOMER</option>
                    <option value="3">RESTAURANT</option>
                </select>
            </div>
            <!-- ‚≠ê H·∫æT FIX -->

            <div class="col-md-2">
                <button class="btn btn-gradient w-100" onclick="createUser()">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- üîπ T√¨m ki·∫øm -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-list-ul text-primary"></i> Danh s√°ch ng∆∞·ªùi d√πng</h5>
        <input id="searchInput" type="text" class="form-control w-25" placeholder="üîç T√¨m theo ID, t√™n, email ho·∫∑c SƒêT...">
    </div>

    <!-- üîπ B·∫£ng ng∆∞·ªùi d√πng -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle" id="userTable">
                <thead>
                <tr>
                    <th>ID</th><th>T√™n ƒëƒÉng nh·∫≠p</th><th>H·ªç</th><th>T√™n</th>
                    <th>Email</th><th>SƒêT</th><th>Vai tr√≤</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="9" class="text-center text-muted fst-italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let users = [];

    // ‚ùå KH√îNG LOAD ROLE T·ª™ API N·ªÆA ‚Äî GI·ªÆ ƒê√öNG Y√äU C·∫¶U C·ª¶A B·∫†N
    function loadRoles(){}

    // Load all users
    async function loadUsers() {
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/users`);
            if (!res.ok) throw new Error();
            users = await res.json();
            renderUsers(users);
            updateStats();
        } catch {
            tbody.innerHTML = `<tr><td colspan="9" class="text-danger text-center">L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng</td></tr>`;
        }
    }

    // Th√™m user
    async function createUser() {
        const data = {
            username: username.value,
            firstName: firstName.value,
            lastName: lastName.value,
            email: email.value,
            phone: phone.value,
            password: password.value,
            roleId: roleSelect.value   // ‚≠ê FIX CH√çNH ‚Äî G·ª¨I ID S·ªê
        };
        if (!data.username || !data.email || !data.password)
            return alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        try {
            const res = await fetch(`${API_BASE}/users`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            alert("‚úÖ Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!");
            loadUsers();
        } catch (err) {
            alert("‚ùå Kh√¥ng th·ªÉ th√™m ng∆∞·ªùi d√πng!\nChi ti·∫øt: " + err.message);
        }
    }

    // Render + th·ªëng k√™ gi·ªØ nguy√™n
    function updateStats() {
        const total = users.length;

        const adminCount = users.filter(u => u.role?.name === "ADMIN").length;
        const restaurantCount = users.filter(u => u.role?.name === "RESTAURANT").length;
        const customerCount = users.filter(u => u.role?.name === "CUSTOMER").length;

        document.getElementById("totalUsers").innerText = total;
        document.getElementById("adminCount").innerText = adminCount;
        document.getElementById("restaurantCount").innerText = restaurantCount;
        document.getElementById("customerCount").innerText = customerCount;
    }

    function renderUsers(list){
        const tbody = document.querySelector("#userTable tbody");
        if (!list.length){
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted fst-italic">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>`;
            return;
        }
        tbody.innerHTML = list.map(u => `
            <tr data-id="${u.id}">
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.firstName}</td>
                <td>${u.lastName}</td>
                <td>${u.email}</td>
                <td>${u.phone}</td>
                <td>${u.role?.name || "‚Äî"}</td>
                <td>
                    <span class="badge ${u.enabled ? "badge-active" : "badge-disabled"}">
                        ${u.enabled ? "Ho·∫°t ƒë·ªông" : "V√¥ hi·ªáu"}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("");
    }

    async function deleteUser(id){
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?")) return;
        try {
            const res = await fetch(`${API_BASE}/users/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error(await res.text());
            alert("üóëÔ∏è X√≥a th√†nh c√¥ng!");
            loadUsers();
        } catch {
            alert("‚ùå L·ªói khi x√≥a ng∆∞·ªùi d√πng!");
        }
    }

    document.getElementById("searchInput").addEventListener("input", e => {
        const kw = e.target.value.toLowerCase().trim();
        if (!kw){ renderUsers(users); updateStats(); return; }
        const filtered = users.filter(u =>
            [u.id, u.username, u.firstName, u.lastName, u.email, u.phone, u.role?.name]
                .some(v => v?.toLowerCase().includes(kw))
        );
        renderUsers(filtered);
        updateStats();
    });

    loadUsers();
</script>
</body>
</html>
