<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Menu NhÃ  hÃ ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #eef2f5; font-family: "Segoe UI", sans-serif; }

        .sidebar {
            position: fixed; top: 0; left: 0;
            width: 230px; height: 100vh;
            background: linear-gradient(180deg, #198754, #146c43);
            padding-top: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        }

        .sidebar a {
            color: white; padding: 12px 20px;
            display: block; text-decoration: none;
            border-left: 4px solid transparent;
            transition: 0.25s;
            font-weight: 500;
        }

        .sidebar a:hover {
            background: rgba(255,255,255,0.12);
            border-left: 4px solid white;
        }

        .content-area { margin-left: 250px; padding: 25px; }
        h3 { font-weight: 700; color: #333; }

        table.table { background: white; border-radius: 10px; overflow: hidden; }
        thead { background: #198754; color: white; }
        tbody tr:hover { background: #f3f6ff; }

        img.menu-thumb {
            width: 60px; height: 60px;
            object-fit: cover; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .btn-primary { background: #198754; border: none; }
        .btn-primary:hover { background: #12693d; }

        .modal-content { border-radius: 12px; }
    </style>
</head>

<body>

<div class="sidebar">
    <a href="/restaurant/dashboard">ğŸ  Dashboard</a>
    <a href="/restaurant/menu">ğŸ• Menu</a>
    <a href="/restaurant/orders">ğŸ“¦ ÄÆ¡n hÃ ng</a>
    <a href="/restaurant/drones">ğŸ›© Drone</a>
    <a href="/restaurant/payments">ğŸ’³ Thanh toÃ¡n</a>
    <a href="/restaurant/profile">ğŸ‘¤ Há»“ sÆ¡</a>
</div>

<div class="content-area">
    <h3>ğŸ• Menu nhÃ  hÃ ng</h3>

    <button class="btn btn-primary my-3" onclick="openModal()">+ ThÃªm mÃ³n</button>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>áº¢nh</th>
            <th>TÃªn mÃ³n</th>
            <th>GiÃ¡</th>
            <th>MÃ´ táº£</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th></th>
        </tr>
        </thead>
        <tbody id="menuTable"></tbody>
    </table>
</div>

<!-- Modal thÃªm mÃ³n -->
<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <h5>ThÃªm mÃ³n má»›i</h5>

            <input class="form-control mb-2" id="name" placeholder="TÃªn mÃ³n">
            <input class="form-control mb-2" id="price" placeholder="GiÃ¡">

            <label class="fw-bold mt-2">áº¢nh mÃ³n Äƒn:</label>
            <input type="file" id="imageFile" class="form-control mb-2" accept="image/*">

            <textarea id="desc" class="form-control mb-2" placeholder="MÃ´ táº£"></textarea>

            <button class="btn btn-success w-100" onclick="addMenu()">ThÃªm</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    let restaurantId = null;

    /* ===================================================
           1) FIX LOAD RESTAURANT 100% ÄÃšNG KEY
    =================================================== */
    async function loadRestaurant() {

        // â­ láº¥y user Ä‘Ãºng key (gá»™p cáº£ 2 loáº¡i)
        const user =
            JSON.parse(localStorage.getItem("loggedInUser")) ||
            JSON.parse(localStorage.getItem("user"));

        console.log("User trong localStorage:", user);

        if (!user || !user.id) {
            alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
            window.location.href = "/login";
            return;
        }

        const ownerId = String(user.id).trim();
        console.log("User ID sau khi trim:", ownerId);

        const res = await fetch("/api/restaurants");
        const restaurants = await res.json();

        console.log("Danh sÃ¡ch restaurants:", restaurants);

        // â­ So sÃ¡nh an toÃ n
        const myRestaurant = restaurants.find(r =>
            r.owner?.id && String(r.owner.id).trim() === ownerId
        );

        console.log("NhÃ  hÃ ng tÃ¬m Ä‘Æ°á»£c:", myRestaurant);

        if (!myRestaurant) {
            alert("âš  TÃ i khoáº£n khÃ´ng cÃ³ nhÃ  hÃ ng! LiÃªn há»‡ Admin Ä‘á»ƒ táº¡o.");
            return;
        }

        // â­ Save ID
        restaurantId = myRestaurant.id;
        console.log("Restaurant ID:", restaurantId);

        loadMenu();
    }

    /* ===================================================
           2) Load danh sÃ¡ch mÃ³n Ä‘Ãºng nhÃ  hÃ ng
    =================================================== */
    function loadMenu() {
        fetch("/api/menu-items")
            .then(res => res.json())
            .then(list => {
                const table = document.getElementById("menuTable");
                table.innerHTML = "";

                list.filter(m => m.restaurant?.id === restaurantId)
                    .forEach(m => {

                        const imgTag = m.imageUrl
                            ? `<img src="/images/${m.imageUrl}" class="menu-thumb" onerror="this.style.display='none';">`
                            : `<span class='text-muted'>KhÃ´ng cÃ³ áº£nh</span>`;

                        table.innerHTML += `
                        <tr>
                            <td>${m.id}</td>
                            <td>${imgTag}</td>
                            <td>${m.name}</td>
                            <td>${m.price.toLocaleString()} â‚«</td>
                            <td>${m.description || ""}</td>
                            <td>${m.available ? "âœ” CÃ²n" : "âŒ Háº¿t"}</td>
                            <td>
                                <button class='btn btn-danger btn-sm' onclick="deleteMenu(${m.id})">XÃ³a</button>
                            </td>
                        </tr>`;
                    });
            });
    }

    /* ===================================================
           3) Modal
    =================================================== */
    function openModal() {
        new bootstrap.Modal(document.getElementById("menuModal")).show();
    }

    /* ===================================================
           4) ThÃªm mÃ³n
    =================================================== */
    async function addMenu() {

        const fileInput = document.getElementById("imageFile");
        let imageUrl = null;

        if (fileInput.files.length > 0) {
            imageUrl = fileInput.files[0].name;
        }

        const item = {
            name: document.getElementById("name").value,
            price: Number(document.getElementById("price").value),
            description: document.getElementById("desc").value,
            imageUrl: imageUrl,
            restaurantId: restaurantId,
            available: true
        };

        const res = await fetch("/api/menu-items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
        });

        if (!res.ok) {
            alert("âŒ KhÃ´ng thá»ƒ táº¡o mÃ³n!");
            return;
        }

        alert("âœ” ThÃªm mÃ³n thÃ nh cÃ´ng!");
        loadMenu();
    }

    /* ===================================================
           5) XÃ³a mÃ³n
    =================================================== */
    function deleteMenu(id) {
        fetch(`/api/menu-items/${id}`, { method: "DELETE" })
            .then(() => {
                alert("ÄÃ£ xÃ³a mÃ³n");
                loadMenu();
            });
    }

    // â­ KHá»I CHáº Y
    loadRestaurant();

</script>

</body>
</html>
