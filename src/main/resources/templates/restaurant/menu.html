<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Menu NhÃ  hÃ ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f4f6f9; }
        .sidebar {
            position: fixed; top: 0; left: 0;
            width: 220px; height: 100vh;
            background: #198754; padding-top: 20px;
        }
        .sidebar a { color: white; padding: 12px 18px; display: block; text-decoration: none; }
        .sidebar a:hover { background: rgba(255,255,255,0.2); }
        .content-area { margin-left: 240px; padding: 20px; }
        img.menu-thumb { width: 55px; height: 55px; object-fit: cover; border-radius: 6px; }
    </style>
</head>

<body>

<div class="sidebar">
    <a href="/restaurant/dashboard">ğŸ  Dashboard</a>
    <a href="/restaurant/menu">ğŸ• Menu</a>
    <a href="/restaurant/orders">ğŸ“¦ ÄÆ¡n hÃ ng</a>
    <a href="/restaurant/payments">ğŸ’³ Thanh toÃ¡n</a>
    <a href="/restaurant/profile">ğŸ‘¤ Há»“ sÆ¡</a>
</div>

<div class="content-area">
    <h3>ğŸ• Menu nhÃ  hÃ ng</h3>
    <button class="btn btn-primary my-3" onclick="openModal()">+ ThÃªm mÃ³n</button>

    <table class="table table-bordered card">
        <thead class="table-success">
        <tr>
            <th>ID</th>
            <th>áº¢nh</th>
            <th>TÃªn mÃ³n</th>
            <th>GiÃ¡</th>
            <th>MÃ´ táº£</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th></th>
        </tr>
        </thead>
        <tbody id="menuTable"></tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <h5>ThÃªm mÃ³n má»›i</h5>

            <input class="form-control mb-2" id="name" placeholder="TÃªn mÃ³n">
            <input class="form-control mb-2" id="price" placeholder="GiÃ¡">

            <label class="fw-bold mt-2">áº¢nh mÃ³n Äƒn:</label>
            <input type="file" id="imageFile" class="form-control mb-2" accept="image/*">

            <textarea id="desc" class="form-control mb-2" placeholder="MÃ´ táº£"></textarea>

            <button class="btn btn-success" onclick="addMenu()">ThÃªm</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    let restaurantId = null;

    /* ===================================================
         1) Láº¥y restaurantId tá»« danh sÃ¡ch restaurants
    =================================================== */
    async function loadRestaurant() {

        const user = JSON.parse(localStorage.getItem("loggedInUser"));

        if (!user) {
            alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
            window.location.href = "/login";
            return;
        }

        const ownerId = user.id;

        // ğŸ”¥ Láº¤Y TOÃ€N Bá»˜ RESTAURANTS Rá»’I Lá»ŒC
        const res = await fetch("http://localhost:8080/api/restaurants");
        const restaurants = await res.json();

        const myRestaurant = restaurants.find(r => r.owner.id === ownerId);

        if (!myRestaurant) {
            alert("âŒ TÃ i khoáº£n cá»§a báº¡n chÆ°a cÃ³ nhÃ  hÃ ng!\nâ†’ HÃ£y táº¡o nhÃ  hÃ ng trÆ°á»›c.");
            return;
        }

        restaurantId = myRestaurant.id;

        loadMenu();
    }

    /* ===================================================
         2) Load danh sÃ¡ch mÃ³n
    =================================================== */
    function loadMenu() {
        fetch("http://localhost:8080/api/menu-items")
            .then(res => res.json())
            .then(list => {
                const table = document.getElementById("menuTable");
                table.innerHTML = "";

                list.filter(m => m.restaurant.id === restaurantId)
                    .forEach(m => {
                        table.innerHTML += `
                        <tr>
                            <td>${m.id}</td>
                            <td><img src="${m.imageUrl || '/default-food.png'}" class="menu-thumb"></td>
                            <td>${m.name}</td>
                            <td>${m.price} â‚«</td>
                            <td>${m.description}</td>
                            <td>${m.available ? "âœ” CÃ²n" : "âŒ Háº¿t"}</td>
                            <td>
                                <button class='btn btn-danger btn-sm' onclick="deleteMenu(${m.id})">XÃ³a</button>
                            </td>
                        </tr>`;
                    });
            });
    }

    /* ===================================================
         3) Má»Ÿ modal
    =================================================== */
    function openModal() {
        new bootstrap.Modal(document.getElementById("menuModal")).show();
    }

    /* ===================================================
         4) ThÃªm mÃ³n
    =================================================== */
    async function addMenu() {

        const fileInput = document.getElementById("imageFile");
        let imageUrl = null;

        if (fileInput.files.length > 0) {
            imageUrl = URL.createObjectURL(fileInput.files[0]);
        }

        const item = {
            name: document.getElementById("name").value,
            price: Number(document.getElementById("price").value),
            description: document.getElementById("desc").value,
            imageUrl: imageUrl,
            restaurantId: restaurantId,
            available: true
        };

        const res = await fetch("http://localhost:8080/api/menu-items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
        });

        if (!res.ok) {
            alert("âŒ KhÃ´ng thá»ƒ táº¡o mÃ³n!");
            return;
        }

        alert("âœ” ThÃªm mÃ³n thÃ nh cÃ´ng!");
        loadMenu();
    }

    /* ===================================================
         5) XÃ³a mÃ³n
    =================================================== */
    function deleteMenu(id) {
        fetch(`http://localhost:8080/api/menu-items/${id}`, { method: "DELETE" })
            .then(() => {
                alert("ÄÃ£ xÃ³a mÃ³n");
                loadMenu();
            });
    }

    // KHá»I CHáº Y
    loadRestaurant();

</script>

</body>
</html>
