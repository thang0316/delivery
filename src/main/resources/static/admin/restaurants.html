<h2 class="dashboard-title mb-4 text-warning">ğŸª Quáº£n lÃ½ NhÃ  hÃ ng</h2>

<div class="card bg-dark text-light p-3">
    <!-- Thanh cÃ´ng cá»¥ -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <input id="searchRestaurant" type="text" class="form-control form-control-sm bg-secondary text-white border-0"
                   placeholder="ğŸ” TÃ¬m kiáº¿m nhÃ  hÃ ng..." style="width:260px;">
            <button class="btn btn-outline-warning btn-sm" onclick="loadRestaurants()">ğŸ”„ Táº£i láº¡i</button>
        </div>
        <div>
            <button class="btn btn-success btn-sm" onclick="openAddModal()">â• ThÃªm NhÃ  hÃ ng</button>
            <span class="text-muted small ms-3" id="totalRestaurant">Äang táº£i...</span>
        </div>
    </div>

    <!-- Báº£ng dá»¯ liá»‡u -->
    <table class="table table-dark table-hover align-middle mb-0">
        <thead class="table-warning text-dark">
        <tr>
            <th>#</th>
            <th>TÃªn NhÃ  hÃ ng</th>
            <th>Chá»§ sá»Ÿ há»¯u</th>
            <th>Äá»‹a chá»‰</th>
            <th>SÄT</th>
            <th>NgÃ y tham gia</th>
            <th>ÄÃ¡nh giÃ¡ â­</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th class="text-center">HÃ nh Ä‘á»™ng</th>
        </tr>
        </thead>
        <tbody id="restaurantTable">
        <tr><td colspan="9" class="text-center text-muted">Äang táº£i dá»¯ liá»‡u...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const apiBase = window.apiBase || "http://localhost:8080/api";

    // ğŸ”¹ Load danh sÃ¡ch nhÃ  hÃ ng
    async function loadRestaurants() {
        const tbody = document.getElementById("restaurantTable");
        const searchValue = document.getElementById("searchRestaurant").value.toLowerCase();
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Äang táº£i...</td></tr>`;

        try {
            const res = await fetch(apiBase + "/restaurants");
            if (!res.ok) throw new Error("KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u!");
            const data = await res.json();

            const filtered = data.filter(r => r.name?.toLowerCase().includes(searchValue));
            document.getElementById("totalRestaurant").textContent = `Tá»•ng: ${filtered.length} nhÃ  hÃ ng`;

            if (!filtered.length) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">KhÃ´ng cÃ³ dá»¯ liá»‡u</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${r.name || "(KhÃ´ng tÃªn)"}</td>
          <td>${r.owner?.username || "â€”"}</td>
          <td>${r.address || "â€”"}</td>
          <td>${r.phone || "â€”"}</td>
          <td>${r.createdAt ? new Date(r.createdAt).toLocaleDateString("vi-VN") : "â€”"}</td>
          <td>${r.rating?.toFixed(1) || "5.0"}</td>
          <td><span class="badge ${r.active ? "bg-success" : "bg-secondary"}">${r.active ? "Hoáº¡t Ä‘á»™ng" : "Táº¡m ngÆ°ng"}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-info" onclick="viewRestaurant('${r.id}')">
              <i class="bi bi-eye"></i> Xem
            </button>
          </td>
        </tr>`).join("");
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">âŒ ${err.message}</td></tr>`;
        }
    }

    // ğŸ”¸ Táº¡o modal Ä‘á»™ng
    function createModal(title, bodyHTML, footerHTML = "") {
        document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
        document.body.classList.remove("modal-open");
        document.body.style.overflow = "";

        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content bg-dark text-light border-0 shadow">
          <div class="modal-header border-secondary">
            <h5 class="modal-title text-warning">${title}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">${bodyHTML}</div>
          ${footerHTML ? `<div class="modal-footer border-secondary">${footerHTML}</div>` : ""}
        </div>
      </div>
    `;
        document.body.appendChild(modal);

        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener("hidden.bs.modal", () => modal.remove());
        return { modal, bsModal };
    }

    // ğŸ‘ï¸ Xem chi tiáº¿t
    async function viewRestaurant(id) {
        const { modal } = createModal("ğŸª ThÃ´ng tin NhÃ  hÃ ng", `<p class='text-muted'>Äang táº£i...</p>`);
        try {
            const res = await fetch(`${apiBase}/restaurants/${id}`);
            if (!res.ok) throw new Error("KhÃ´ng tÃ¬m tháº¥y nhÃ  hÃ ng!");
            const r = await res.json();

            modal.querySelector(".modal-body").innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>TÃªn nhÃ  hÃ ng:</strong> ${r.name || "â€”"}</p>
            <p><strong>Chá»§ sá»Ÿ há»¯u:</strong> ${r.owner?.username || "â€”"}</p>
            <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> ${r.phone || "â€”"}</p>
            <p><strong>ÄÃ¡nh giÃ¡:</strong> ${r.rating?.toFixed(1) || "5.0"} â­</p>
          </div>
          <div class="col-md-6">
            <p><strong>Äá»‹a chá»‰:</strong> ${r.address || "â€”"}</p>
            <p><strong>NgÃ y tham gia:</strong> ${r.createdAt ? new Date(r.createdAt).toLocaleDateString("vi-VN") : "â€”"}</p>
            <p><strong>Tráº¡ng thÃ¡i:</strong> ${r.active ? "<span class='text-success'>Hoáº¡t Ä‘á»™ng</span>" : "<span class='text-danger'>Táº¡m ngÆ°ng</span>"}</p>
          </div>
        </div>`;
        } catch (err) {
            modal.querySelector(".modal-body").innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
    }

    // â• ThÃªm nhÃ  hÃ ng
    function openAddModal() {
        const formHTML = `
      <form id="addRestaurantForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label text-warning fw-semibold">TÃªn nhÃ  hÃ ng</label>
          <input type="text" id="resName" class="form-control bg-secondary text-white border-0" required>
        </div>
        <div class="col-md-6">
          <label class="form-label text-warning fw-semibold">ID chá»§ sá»Ÿ há»¯u</label>
          <input type="text" id="resOwner" class="form-control bg-secondary text-white border-0" required>
        </div>
        <div class="col-md-6">
          <label class="form-label text-warning fw-semibold">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
          <input type="text" id="resPhone" class="form-control bg-secondary text-white border-0">
        </div>
        <div class="col-md-6">
          <label class="form-label text-warning fw-semibold">Äá»‹a chá»‰</label>
          <input type="text" id="resAddress" class="form-control bg-secondary text-white border-0">
        </div>
      </form>
    `;
        const footer = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Há»§y</button>
      <button type="button" class="btn btn-success" onclick="addRestaurant()">LÆ°u</button>
    `;
        createModal("â• ThÃªm NhÃ  hÃ ng má»›i", formHTML, footer);
    }

    // ğŸŸ¢ Submit thÃªm má»›i
    async function addRestaurant() {
        const name = document.getElementById("resName").value.trim();
        const ownerId = document.getElementById("resOwner").value.trim();
        const phone = document.getElementById("resPhone").value.trim();
        const address = document.getElementById("resAddress").value.trim();

        if (!name || !ownerId) return alert("âš ï¸ Vui lÃ²ng nháº­p TÃªn nhÃ  hÃ ng vÃ  ID chá»§ sá»Ÿ há»¯u!");

        try {
            const res = await fetch(apiBase + "/restaurants", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name,
                    address,
                    phone,
                    owner: { id: ownerId },
                    active: true
                })
            });
            if (!res.ok) throw new Error("ThÃªm nhÃ  hÃ ng tháº¥t báº¡i!");
            alert("âœ… ThÃªm nhÃ  hÃ ng thÃ nh cÃ´ng!");
            document.querySelectorAll(".modal.show").forEach(m => bootstrap.Modal.getInstance(m).hide());
            loadRestaurants();
        } catch (err) {
            alert("âŒ " + err.message);
        }
    }

    // ğŸš€ Khá»Ÿi cháº¡y
    loadRestaurants();
</script>

<style>
    .modal-backdrop.show {
        opacity: 0.35 !important;
        background-color: #000 !important;
    }
    .modal-content input::placeholder {
        color: #bbb;
    }
    .table-dark th, .table-dark td {
        vertical-align: middle;
    }
</style>
