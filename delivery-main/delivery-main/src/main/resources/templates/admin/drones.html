<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>üöÅ Qu·∫£n l√Ω Drone | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="p-4 bg-light">
<div class="container">
    <h3 class="text-primary mb-3">üöÅ Th√™m Drone m·ªõi</h3>

    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <input id="model" class="form-control" placeholder="Model drone (VD: DJI)">
        </div>
        <div class="col-md-2">
            <select id="status" class="form-select">
                <option value="ACTIVE">ACTIVE</option>
                <option value="IDLE">IDLE</option>
                <option value="CHARGING">CHARGING</option>
                <option value="OFFLINE">OFFLINE</option>
            </select>
        </div>
        <div class="col-md-2">
            <input id="batteryLevel" type="number" min="0" max="100" class="form-control" placeholder="Pin (%)">
        </div>
        <div class="col-md-3">
            <select id="restaurantSelect" class="form-select">
                <option disabled selected>ƒêang t·∫£i nh√† h√†ng...</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="createDrone()">Th√™m</button>
        </div>
    </div>

    <!-- B·∫£ng hi·ªÉn th·ªã Drone -->
    <table class="table table-striped align-middle mt-4">
        <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>Model</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Pin (%)</th>
            <th>Nh√† h√†ng</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="droneTable">
        <tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    // üü¢ Load danh s√°ch nh√† h√†ng v√†o combobox
    async function loadRestaurants() {
        const select = document.getElementById("restaurantSelect");
        try {
            const res = await fetch(`${API_BASE}/restaurants`);
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh√† h√†ng!");
            const data = await res.json();

            if (!Array.isArray(data) || data.length === 0) {
                select.innerHTML = `<option disabled>Kh√¥ng c√≥ nh√† h√†ng n√†o</option>`;
                return;
            }

            // ‚úÖ T·∫°o danh s√°ch option
            select.innerHTML = data.map(r => `
      <option value="${r.id}">${r.name} - Ch·ªß: ${r.owner?.username || "?"}</option>
    `).join("");
            console.log("‚úÖ Combobox loaded:", data);
        } catch (err) {
            console.error("‚ùå L·ªói khi load nh√† h√†ng:", err);
            select.innerHTML = `<option disabled>L·ªói t·∫£i nh√† h√†ng</option>`;
        }
    }

    // üü¢ Load danh s√°ch Drone
    async function loadDrones() {
        const tbody = document.getElementById("droneTable");
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/drones`);
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i drone!");
            const drones = await res.json();

            if (!drones.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted fst-italic">Ch∆∞a c√≥ drone n√†o</td></tr>`;
                return;
            }

            tbody.innerHTML = drones.map(d => `
      <tr>
        <td>${d.id}</td>
        <td>${d.model}</td>
        <td>${d.status}</td>
        <td>${d.batteryLevel || 0}%</td>
        <td>${d.restaurant?.name || "‚Äî"}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteDrone('${d.id}')">üóëÔ∏è</button>
        </td>
      </tr>
    `).join("");
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‚ùå ${err.message}</td></tr>`;
        }
    }

    // üü¢ T·∫°o drone m·ªõi
    async function createDrone() {
        const model = document.getElementById("model").value.trim();
        const status = document.getElementById("status").value;
        const batteryLevel = parseFloat(document.getElementById("batteryLevel").value);
        const restaurantId = document.getElementById("restaurantSelect").value;

        if (!model || !status || isNaN(batteryLevel) || !restaurantId) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        const data = { model, status, batteryLevel, restaurantId };
        console.log("üì§ G·ª≠i request:", data);

        try {
            const res = await fetch(`${API_BASE}/drones`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            alert("‚úÖ Th√™m drone th√†nh c√¥ng!");
            loadDrones();
        } catch (err) {
            alert("‚ùå L·ªói th√™m drone!\n" + err.message);
        }
    }

    // üü¢ X√≥a drone
    async function deleteDrone(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a drone n√†y?")) return;
        try {
            const res = await fetch(`${API_BASE}/drones/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error(await res.text());
            alert("üóëÔ∏è Drone ƒë√£ b·ªã x√≥a!");
            loadDrones();
        } catch (err) {
            alert("‚ùå Kh√¥ng th·ªÉ x√≥a drone!\n" + err.message);
        }
    }

    // üü¢ Ch·∫°y khi t·∫£i trang
    (async () => {
        await loadRestaurants();
        await loadDrones();
    })();
</script>
</body>
</html>
