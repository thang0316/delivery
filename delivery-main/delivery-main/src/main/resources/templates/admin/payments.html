<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ’³ Quáº£n lÃ½ Thanh toÃ¡n | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light p-4">
<div class="container">
    <h3 class="text-primary mb-3">ğŸ’³ Quáº£n lÃ½ Thanh toÃ¡n</h3>

    <!-- ğŸ”¹ Form thÃªm thanh toÃ¡n -->
    <div class="p-3 border bg-white rounded mb-4">
        <h5 class="text-success mb-3">â• ThÃªm Thanh toÃ¡n má»›i</h5>
        <div class="row g-2">
            <div class="col-md-3">
                <select id="orderSelect" class="form-select">
                    <option disabled selected>Äang táº£i Ä‘Æ¡n hÃ ng...</option>
                </select>
            </div>
            <div class="col-md-2">
                <input id="method" class="form-control" placeholder="PhÆ°Æ¡ng thá»©c (VD: CASH, CARD)" />
            </div>
            <div class="col-md-2">
                <input id="amount" type="number" min="0" class="form-control" placeholder="Sá»‘ tiá»n (VNÄ)" />
            </div>
            <div class="col-md-2">
                <select id="status" class="form-select">
                    <option value="PENDING">PENDING</option>
                    <option value="SUCCESS">SUCCESS</option>
                    <option value="FAILED">FAILED</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="createPayment()">ThÃªm</button>
            </div>
        </div>
    </div>

    <!-- ğŸ”¹ Báº£ng hiá»ƒn thá»‹ danh sÃ¡ch -->
    <table class="table table-striped align-middle">
        <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>ÄÆ¡n hÃ ng</th>
            <th>PhÆ°Æ¡ng thá»©c</th>
            <th>Sá»‘ tiá»n (VNÄ)</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>Thá»i gian</th>
            <th>HÃ nh Ä‘á»™ng</th>
        </tr>
        </thead>
        <tbody id="payTable">
        <tr><td colspan="7" class="text-center text-muted">Äang táº£i dá»¯ liá»‡u...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    // ğŸŸ¢ Load danh sÃ¡ch Ä‘Æ¡n hÃ ng Ä‘á»ƒ chá»n khi thÃªm thanh toÃ¡n
    async function loadOrders() {
        const select = document.getElementById("orderSelect");
        try {
            const res = await fetch(`${API_BASE}/orders`);
            if (!res.ok) throw new Error("KhÃ´ng thá»ƒ táº£i danh sÃ¡ch Ä‘Æ¡n hÃ ng!");
            const data = await res.json();
            if (!data.length) {
                select.innerHTML = `<option disabled>KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o</option>`;
                return;
            }
            select.innerHTML = data.map(o =>
                `<option value="${o.id}">#${o.id} - ${o.status || "Unknown"}</option>`
            ).join("");
        } catch (err) {
            console.error("âŒ Lá»—i load orders:", err);
            select.innerHTML = `<option disabled>Lá»—i táº£i Ä‘Æ¡n hÃ ng</option>`;
        }
    }

    // ğŸŸ¢ Load danh sÃ¡ch thanh toÃ¡n
    async function loadPayments() {
        const tbody = document.getElementById("payTable");
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Äang táº£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/payments`);
            if (!res.ok) throw new Error("KhÃ´ng thá»ƒ táº£i danh sÃ¡ch thanh toÃ¡n!");
            const data = await res.json();

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted fst-italic">ChÆ°a cÃ³ thanh toÃ¡n nÃ o</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(p => `
      <tr>
        <td>${p.id}</td>
        <td>${p.order?.id || "â€”"}</td>
        <td>${p.method || "â€”"}</td>
        <td>${p.amount?.toLocaleString("vi-VN") || 0}</td>
        <td>${p.status}</td>
        <td>${p.createdAt || "â€”"}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${p.id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `).join("");
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">âŒ ${err.message}</td></tr>`;
        }
    }

    // ğŸŸ¢ Táº¡o thanh toÃ¡n má»›i
    async function createPayment() {
        const orderId = document.getElementById("orderSelect").value;
        const method = document.getElementById("method").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
        const status = document.getElementById("status").value;

        if (!orderId || !method || isNaN(amount)) {
            alert("âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
            return;
        }

        const data = { orderId, method, amount, status };
        console.log("ğŸ“¤ Gá»­i request:", data);

        try {
            const res = await fetch(`${API_BASE}/payments`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            alert("âœ… ThÃªm thanh toÃ¡n thÃ nh cÃ´ng!");
            loadPayments();
        } catch (err) {
            alert("âŒ Lá»—i thÃªm thanh toÃ¡n!\n" + err.message);
        }
    }

    // ğŸŸ¢ XÃ³a thanh toÃ¡n
    async function deletePayment(id) {
        if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a thanh toÃ¡n nÃ y?")) return;
        try {
            const res = await fetch(`${API_BASE}/payments/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error(await res.text());
            alert("ğŸ—‘ï¸ Thanh toÃ¡n Ä‘Ã£ bá»‹ xÃ³a!");
            loadPayments();
        } catch (err) {
            alert("âŒ KhÃ´ng thá»ƒ xÃ³a thanh toÃ¡n!\n" + err.message);
        }
    }

    // ğŸŸ¢ Khá»Ÿi táº¡o
    window.addEventListener("DOMContentLoaded", async () => {
        await loadOrders();
        await loadPayments();
    });
</script>
</body>
</html>
